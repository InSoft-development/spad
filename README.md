# spad
## Терминология
### project
анализируемая установка, проект целиком, объект, куда мы поставляем нашу разработку. Одна поставка - один проект. Сосуществование на одной железке двух разных проектов пока не рассматривается и не тестриуется, хотя такие возможности закладываются.
### task
исполняемый файл с его набором параметров для запуска.
### workflow
алгоритм анализа, состоящий из набора последовательных и параллельных тасков - запусков исполняемых файлов. Часть можно запустить в фоне, остальное - одно за другим. Это может быть и некоторый конечный расчет - который будет завершен -  или непрерывный процесс анализа. Мы не рассчитываем на обязательное штатное завершение работы workflow: оно может работать “вечно”. При падении с ошибкой какого либо таска - он будет однократно перезапущен (впоследствии - многократно). Если последовательность тасков из списка закончит исполнение - будут ожидаться параллельно запущенные таски. При отключении железки - при перезапуске системы - будут перезапускаться те воркфлоу, которые были запущены, но не завершены.

## Файлы в репозитории
* srv.py - Сервер запуска приложений. JSON-RPC. Запускается без параметров. Всё хранит в /opt/spa
* run.py - скрипт, запускающийся сервером в отдельном процессе и исполняющий воркфлоу. Пораждает процессы, которые запускают таски, работающие в параллель. Останавливается штатно командой stop из srv.py - сигналом SIGUSR1. Все остальные попытки его убить - убивают его жестко. Останов занимает довольно долгое время, так как может ожидать штатной остановки тасков.
* spa_conn - фронтенд для работы с srv.py не через curl - чуть-чуть удобнее.
* simple, error, wait - простые баш скрипты для тетирования работы воркфлоу, хранятся вместе со всеми бинарями - как ссылки - в /opt/spa/bin - туда же надо сложить ссылки на все используемые бинари (ну или сами бинари)
* command_*.json - json файлы для тестирования с помощью curl или spa_ctl
* alarms.py - скрипт, отслеживающий в базе данных сигналы об аномалиях и добавляющий некоторую логику к обработке их - логирование, записи в отдельную таблицу. Ему тут не место, впринципе, и в целом решение такое себе...

## JSON файл, используемый для создания и редактирования workflow
Пример
```
{
    "context": {
        "project":
            {
                "id": 1,
                "name": "pr1",
                "workflows": [
                    {
                        "id": 1,
                        "name": "wf1",
                        "tasks": [
                            {
                                "id": 1,
                                "name": "t11",
                                "place": 1,
                                "exec": "parallel",
                                "function": "simple",
                                "params": [
                                    "0"
                                ]
                            },
                            {
                                "id": 2,
                                "name": "t12",
                                "place": 2,
                                "exec": "await",
                                "function": "simple",
                                "params": [
                                    "5"
                                ]
                            }
                        ]
                    },
                    {
                        "id": 2,
                        "name": "wf2",
                        "tasks": [
                            {
                                "id": 1,
                                "name": "t21",
                                "place": 1,
                                "exec": "parallel",
                                "function": "simple",
                                "params": [
                                    "10"
                                ]
                            },
                            {
                                "id": 2,
                                "name": "t22",
                                "place": 2,
                                "exec": "await",
                                "function": "echo",
                                "params": [
                                    "5"
                                ]
                            }
                        ]
                    }
                ]
            }
    }
}

```

# spa_ctl
## Команды spa_ctl

### select_project
_spa_ctl select_project <project name>_

Параметр - имя проекта. На данный момент не тестировалась возможность работы с двумя проектами с одной машины. Но рекомендуется явно выбрать проект, прежде чем начать работу.

### create
_spa_ctl create (-j <json string> | -f <json file>)_

Создание и дополнение проекта новыми воркфлоу и тасками по указанным конфиграциям json, имеющему древовидную структуру.
Параметром полный json в виде строки в кавычках - или файла, со всеми полями. Если проект или воркфлоу, указанные в json уже существуют - таски (или новые воркфлоу) будут добавлены туда. Проект, указанный в json - запоминается как текущий проект. Нумерация новых тасков “подвинет” уже существующие вниз. Осуществляется выбор проекта из json

### delete
_spa_ctl delete (-j <json string> | -f <json file>)_

Удаление существующих тасков и воркфлоу, чьи имена будут “листьями” дерева в json.
Параметром json-дерево. Полный json чего хотим удалить до уровня, на котором будем удалять: task или workflow - на ком дерево обрывается - того и удаляем. Запущенное - удалять нельзя. Только остановленное. Project - удалять нельзя, так как он соответствует объекту материального мира, существующему помимо нашего желания его удалить. Проект, указанный в json - запоминается как текущий проект.
(переделаю на возможность указания упрощенно - через опции project-wf-task)
(можно последовательно в одном json удалять по нескольку раз таски и даже воркфлоу. Там последовательный перебор с удалением.)

### update
_spa_ctl update -j <json string> | -f <json file>_

Параметром json дерево. Запущенное - изменять нельзя. Только остановленное. Выполняется как последовательный delete и create. Таким образом, нет возможности изменить один параметр - надо изменять целиком всю сущность, указывая все ее параметры. Для удобства - использовать dump для получения текущей конфигурации.

### run
_spa_ctl run -p <project> -w <workflow> (-t <task>)_

Запуск на исполнение workflow. Workflow исполняется согласно его json файлу. Исполнение последовательности тасков происходит в отдельном процессе линукса. Параллельные таски - отстреливаются в еще отдельнгые дочерние процессы. Указанный project будет запомнен как текущий. Запускать параллельно можно любое количество воркфлоу - до ограничений системы.

### stop
_spa_ctl stop -w <workflow>_

указать workflow (указывать проект не обязательно - так как предполагается, что мы работаем только с одним проектом на одном сервере, и воркфлоу будет найдено среди списка уже запущенных). Остановки отдельных тасков нет. Остановка отдельного последовательного таска с перескоком на следующий не осуществляется - так как предполагается зависимость между последовательно исполняемыми тасками. Остановка параллельно исполняемого таска так же не осуществляется - так как предполагается, что без его работы - будет невозможно исполнение текущего таска из последовательных.

### status
_spa_ctl status -p <project> -w <workflow> (-t <task>)_

Запрос статусов текущих исполняемых процессов в workflow.
Указать project и workflow обязательно, можно указать task
Статусы возможны следующие:
* new - устанавливается всем в начале запуска workflow, затирая статусы с прошлого запуска
* not run - при чтении таска из его файла
* running - исполняется в данный момент
* waiting - экспериментальный статус, который возможно установить через set_status, означающий долгие вычисления во внешней библиотеке, во время которых таск нельзя завершать или убивать штатными средствами. Пока нет ясности в его функциональности и не до конца оттестирован.
* error(+code) - завершился с ошибкой, означенной кодом (линуксовый код завершения процесса больше нуля)
* rerun - перезапуск после завершения с ошибкой. На данный момент - однократный. Так как не смог реализовать простого и надежного механизма подсчета попыток перезапуска.
* success0 - завершен без ошибок (код ноль)
* terminated(-code) - завершен внешним сигналом (код возврата меньше нуля).
* stopping - начало процесса остановки таска
* stopped - успешно остановлен нами спустя максимум - 6 секунд после начала процесса остановки.
* killed - не удалось остановить (подвис) - послан сигнал terminate
* immortal(pid) - не завершился после сигнала terminate, оставляем попытки его убить. Дальнейшее отслеживание - по выданному pid.

### dump
_spa_ctl status -p <project> -w <workflow> (-t <task>)_

Возвращает существующую конфигурацию проекта, воркфлоу или таска в виде json
Указать project и workflow обязательно, можно указать task
Его результат можно использовать для команды update.

### set_status
_spa_ctl status -p <project> -w <workflow> -t <task>_

Принудительная установка некоторого статуса указанному таску.
Создана для возможности установить статус waiting при входе во внешнюю библиотеку, во время работы в которой - процесс нельзя трогать. Тестировалось мало.

### file
Копирование файлов на и с сервера.
В разработке
